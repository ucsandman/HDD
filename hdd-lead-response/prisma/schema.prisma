generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// ============================================================================
// NextAuth.js Required Tables
// ============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// Application Tables
// ============================================================================

model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique @db.VarChar(255)
  emailVerified DateTime? @map("email_verified")
  name          String?   @db.VarChar(255)
  image         String?   @db.Text
  role          String    @default("editor") @db.VarChar(50)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  accounts Account[]
  sessions Session[]
  leads    Lead[]    @relation("CreatedBy")
  messages Message[] @relation("SentBy")

  @@map("users")
}

model Lead {
  id                    String    @id @default(uuid()) @db.Uuid
  // Contact info
  firstName             String    @map("first_name") @db.VarChar(100)
  lastName              String?   @map("last_name") @db.VarChar(100)
  email                 String?   @db.VarChar(255)
  phone                 String?   @db.VarChar(50)
  phoneNormalized       String?   @map("phone_normalized") @db.VarChar(20)
  // Project info
  address               String?   @db.VarChar(500)
  city                  String?   @db.VarChar(100)
  projectType           String?   @map("project_type") @db.VarChar(100)
  projectDescription    String?   @map("project_description") @db.Text
  source                String?   @db.VarChar(100)
  // Status tracking
  status                String    @default("new") @db.VarChar(50)
  // Sequence tracking
  sequenceStatus        String    @default("active") @map("sequence_status") @db.VarChar(50)
  sequenceStep          Int       @default(0) @map("sequence_step")
  nextFollowupAt        DateTime? @map("next_followup_at")
  sequenceExpiresAt     DateTime? @map("sequence_expires_at")
  // Engagement tracking
  lastContactedAt       DateTime? @map("last_contacted_at")
  lastRespondedAt       DateTime? @map("last_responded_at")
  consultationBookedAt  DateTime? @map("consultation_booked_at")
  // Rate limiting
  lastSmsAt             DateTime? @map("last_sms_at")
  smsCountToday         Int       @default(0) @map("sms_count_today")
  smsCountResetAt       DateTime? @map("sms_count_reset_at")
  // Outcome
  closedAt              DateTime? @map("closed_at")
  closedReason          String?   @map("closed_reason") @db.VarChar(100)
  // Metadata
  notes                 String?   @db.Text
  externalId            String?   @map("external_id") @db.VarChar(255)
  createdById           String?   @map("created_by") @db.Uuid
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  createdBy User?     @relation("CreatedBy", fields: [createdById], references: [id])
  messages  Message[]

  @@index([status])
  @@index([sequenceStatus])
  @@index([nextFollowupAt])
  @@index([sequenceExpiresAt])
  @@index([phoneNormalized])
  @@index([email])
  @@index([externalId])
  @@map("leads")
}

model Message {
  id          String   @id @default(uuid()) @db.Uuid
  leadId      String   @map("lead_id") @db.Uuid
  // Message details
  channel     String   @db.VarChar(20) // sms, email
  direction   String   @db.VarChar(10) // inbound, outbound
  // Content
  subject     String?  @db.VarChar(255)
  body        String   @db.Text
  // Status
  status      String   @default("sent") @db.VarChar(50)
  externalId  String?  @map("external_id") @db.VarChar(255)
  errorMessage String? @map("error_message") @db.Text
  // Metadata
  sequenceStep Int?    @map("sequence_step")
  sentById    String?  @map("sent_by") @db.Uuid
  sentAt      DateTime @default(now()) @map("sent_at")
  createdAt   DateTime @default(now()) @map("created_at")

  lead   Lead  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  sentBy User? @relation("SentBy", fields: [sentById], references: [id])

  @@index([leadId])
  @@index([channel])
  @@index([direction])
  @@index([sentAt])
  @@map("messages")
}

model SequenceStep {
  id            String   @id @default(uuid()) @db.Uuid
  stepNumber    Int      @unique @map("step_number")
  name          String   @db.VarChar(100)
  // Timing
  delayMinutes  Int      @map("delay_minutes")
  // Templates
  smsTemplate   String?  @map("sms_template") @db.Text
  emailSubject  String?  @map("email_subject") @db.VarChar(255)
  emailTemplate String?  @map("email_template") @db.Text
  // Config
  sendSms       Boolean  @default(true) @map("send_sms")
  sendEmail     Boolean  @default(true) @map("send_email")
  isActive      Boolean  @default(true) @map("is_active")
  // Metadata
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("sequence_steps")
}

model Setting {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique @db.VarChar(100)
  value     String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model ProcessedWebhook {
  id            String   @id @default(uuid()) @db.Uuid
  webhookId     String   @unique @map("webhook_id") @db.VarChar(255)
  webhookType   String   @map("webhook_type") @db.VarChar(50)
  processedAt   DateTime @default(now()) @map("processed_at")
  expiresAt     DateTime @map("expires_at")

  @@index([webhookId])
  @@index([expiresAt])
  @@map("processed_webhooks")
}
